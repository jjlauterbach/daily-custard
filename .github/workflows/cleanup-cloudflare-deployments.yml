name: Cleanup Cloudflare Deployments

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete Cloudflare Pages Deployment
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PROJECT_NAME: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
        run: |
          # Get all deployments for this PR
          DEPLOYMENTS=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/deployments" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json")
          
          # Filter deployments for this PR branch
          PR_BRANCH="pr-${{ github.event.pull_request.number }}"
          
          # Extract deployment IDs and delete them
          echo "${DEPLOYMENTS}" | jq -r ".result[] | select(.deployment_trigger.metadata.branch == \"${PR_BRANCH}\") | .id" | while read DEPLOYMENT_ID; do
            if [ ! -z "$DEPLOYMENT_ID" ]; then
              echo "Deleting deployment: ${DEPLOYMENT_ID}"
              curl -X DELETE \
                "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/deployments/${DEPLOYMENT_ID}" \
                -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                -H "Content-Type: application/json"
              echo "Deleted deployment ${DEPLOYMENT_ID}"
            fi
          done
          
          echo "Cleanup completed for PR #${{ github.event.pull_request.number }}"
