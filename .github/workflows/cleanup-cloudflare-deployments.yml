name: Cleanup Cloudflare Deployments

permissions:
  contents: read

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete Cloudflare Pages Deployment
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PROJECT_NAME: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
        run: |
          set -euo pipefail

          # Get all deployments for this PR
          DEPLOYMENTS=$(curl -fsS -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/deployments" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json")

          # Filter deployments for this PR branch
          PR_BRANCH="pr-${{ github.event.pull_request.number }}"

          # Extract deployment IDs and delete them
          echo "${DEPLOYMENTS}" | jq -r ".result[] | select(.deployment_trigger.metadata.branch == \"${PR_BRANCH}\") | .id" | while read DEPLOYMENT_ID; do
            if [ -n "${DEPLOYMENT_ID}" ]; then
              echo "Deleting deployment: ${DEPLOYMENT_ID}"
              RESPONSE=$(curl -fsS -X DELETE \
                "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/deployments/${DEPLOYMENT_ID}" \
                -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                -H "Content-Type: application/json")
              if [ "$(echo "${RESPONSE}" | jq -r '.success')" != "true" ]; then
                echo "Failed to delete deployment ${DEPLOYMENT_ID}: ${RESPONSE}" >&2
                exit 1
              fi
              echo "Deleted deployment ${DEPLOYMENT_ID}"
            fi
          done
          echo "Cleanup completed for PR #${{ github.event.pull_request.number }}"
